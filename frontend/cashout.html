<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hamdard | Cashout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100vh;
      overflow-x: hidden;
      position: fixed;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #f4f6f8;
      display: flex;
      flex-direction: column;
    }

    .app-header {
      background: linear-gradient(135deg, #0066B2, #004D8C);
      color: #fff;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .back-btn {
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
    }

    .app-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 16px 16px 80px;
    }

    .content-wrapper::-webkit-scrollbar {
      display: none;
    }

    /* Balance Card */
    .balance-card {
      background: linear-gradient(135deg, #0066B2, #004D8C);
      padding: 24px;
      border-radius: 18px;
      box-shadow: 0 6px 20px rgba(0, 102, 178, 0.3);
      color: #fff;
      margin-bottom: 24px;
      text-align: center;
    }

    .balance-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .balance-amount {
      font-size: 38px;
      font-weight: 700;
      line-height: 1;
    }

    /* Form Card */
    .form-card {
      background: #fff;
      padding: 24px;
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .form-card h3 {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 16px;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }

    input, select {
      width: 100%;
      padding: 14px;
      margin-top: 6px;
      border-radius: 12px;
      border: 1.5px solid #d1d5db;
      font-size: 15px;
      background: #f9fafb;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #0066B2;
      background: #fff;
    }

    input[readonly] {
      background: #f3f4f6;
      color: #6b7280;
    }

    .amount-input-wrapper {
      position: relative;
    }

    .currency-symbol {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      font-weight: 600;
      color: #6b7280;
      pointer-events: none;
    }

    .amount-input-wrapper input {
      padding-left: 36px;
      font-size: 24px;
      font-weight: 600;
      color: #111827;
    }

    .quick-amounts {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .quick-amount-btn {
      padding: 10px;
      background: #f3f4f6;
      border: 1.5px solid #e5e7eb;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-amount-btn:active {
      background: #0066B2;
      color: #fff;
      border-color: #0066B2;
    }

    .info-box {
      background: #e8f4fd;
      border: 1px solid #93c5fd;
      border-radius: 12px;
      padding: 14px;
      margin-top: 16px;
      font-size: 12px;
      color: #1e40af;
    }

    .info-box strong {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .bank-details-display {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-top: 8px;
    }

    .bank-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .bank-detail-row:last-child {
      border-bottom: none;
    }

    .bank-detail-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }

    .bank-detail-value {
      font-size: 13px;
      color: #111827;
      font-weight: 600;
    }

    .btn-submit {
      width: 100%;
      margin-top: 24px;
      padding: 16px;
      background: #0066B2;
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 102, 178, 0.3);
    }

    .btn-submit:active {
      background: #004D8C;
      transform: scale(0.98);
    }

    .btn-submit:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
    }

    .error-message {
      color: #dc2626;
      font-size: 12px;
      margin-top: 6px;
      display: none;
    }

    .error-message.show {
      display: block;
    }
  </style>
</head>

<body>

<div class="app-header">
  <button class="back-btn" onclick="location.href='wallet.html'">‚Üê</button>
  <h2>Cashout to Bank</h2>
</div>

<div class="content-wrapper">

  <!-- Available Balance -->
  <div class="balance-card">
    <div class="balance-label">Available Balance</div>
    <div class="balance-amount" id="available-balance">‚Çπ0.00</div>
  </div>

  <!-- Cashout Form -->
  <div class="form-card">
    <h3>Transfer Details</h3>

    <label>Bank Account</label>
    <div class="bank-details-display" id="bank-details">
      <p style="text-align: center; color: #9ca3af; padding: 20px;">
        Loading bank details...
      </p>
    </div>

    <label>Enter Amount</label>
    <div class="amount-input-wrapper">
      <span class="currency-symbol">‚Çπ</span>
      <input type="number" id="amount-input" placeholder="0.00" min="1" step="0.01">
    </div>
    <div class="error-message" id="amount-error">Insufficient balance</div>

    <div class="quick-amounts">
      <button class="quick-amount-btn" onclick="setAmount(100)">‚Çπ100</button>
      <button class="quick-amount-btn" onclick="setAmount(500)">‚Çπ500</button>
      <button class="quick-amount-btn" onclick="setAmount(1000)">‚Çπ1000</button>
    </div>

    <div class="info-box">
      <strong>üìù Note:</strong>
      This is a demo transfer. In production, money will be transferred to your bank account within 2-3 business days.
    </div>

    <button class="btn-submit" id="submit-btn" onclick="submitCashout()">
      Transfer Now
    </button>
  </div>

</div>

<script>
const API_BASE = window.location.hostname === 'localhost'
    ? "http://127.0.0.1:8001/api"
    : "https://hamdard-udaan-1.onrender.com/api";
const userId = localStorage.getItem("user_id");

let availableBalance = 0;
let bankDetails = null;

if (!userId) {
  alert("Please login first");
  location.href = "index.html";
}

// Load wallet balance
async function loadBalance() {
  try {
    const response = await fetch(`${API}/wallet/balance?user_id=${userId}`);
    const data = await response.json();
    
    if (response.ok) {
      availableBalance = data.balance || 0;
      document.getElementById('available-balance').innerText = `‚Çπ${availableBalance.toFixed(2)}`;
    }
  } catch (error) {
    console.error('Error loading balance:', error);
  }
}

// Load bank details
async function loadBankDetails() {
  try {
    const response = await fetch(`${API}/bank?user_id=${userId}`);
    const data = await response.json();
    
    if (response.ok) {
      bankDetails = data;
      document.getElementById('bank-details').innerHTML = `
        <div class="bank-detail-row">
          <span class="bank-detail-label">Account Holder</span>
          <span class="bank-detail-value">${data.account_holder_name}</span>
        </div>
        <div class="bank-detail-row">
          <span class="bank-detail-label">Bank</span>
          <span class="bank-detail-value">${data.bank_name}</span>
        </div>
        <div class="bank-detail-row">
          <span class="bank-detail-label">Account Number</span>
          <span class="bank-detail-value">****${data.account_number.slice(-4)}</span>
        </div>
        <div class="bank-detail-row">
          <span class="bank-detail-label">IFSC</span>
          <span class="bank-detail-value">${data.ifsc}</span>
        </div>
      `;
    } else {
      document.getElementById('bank-details').innerHTML = `
        <p style="text-align: center; color: #dc2626; padding: 20px;">
          ‚ö†Ô∏è No bank account found. Please add bank details first.
        </p>
      `;
      document.getElementById('submit-btn').disabled = true;
    }
  } catch (error) {
    console.error('Error loading bank details:', error);
    document.getElementById('bank-details').innerHTML = `
      <p style="text-align: center; color: #dc2626; padding: 20px;">
        ‚ùå Failed to load bank details
      </p>
    `;
  }
}

// Set quick amount
function setAmount(amount) {
  document.getElementById('amount-input').value = amount;
  validateAmount();
}

// Validate amount
function validateAmount() {
  const amount = parseFloat(document.getElementById('amount-input').value);
  const errorDiv = document.getElementById('amount-error');
  
  if (isNaN(amount) || amount <= 0) {
    errorDiv.innerText = "Please enter a valid amount";
    errorDiv.classList.add('show');
    return false;
  }
  
  if (amount > availableBalance) {
    errorDiv.innerText = `Insufficient balance. Available: ‚Çπ${availableBalance.toFixed(2)}`;
    errorDiv.classList.add('show');
    return false;
  }
  
  errorDiv.classList.remove('show');
  return true;
}

// Submit cashout
async function submitCashout() {
  if (!validateAmount()) {
    return;
  }
  
  if (!bankDetails) {
    alert("‚ö†Ô∏è Please add bank details first");
    return;
  }
  
  const amount = parseFloat(document.getElementById('amount-input').value);
  const submitBtn = document.getElementById('submit-btn');
  
  submitBtn.disabled = true;
  submitBtn.innerText = "Processing...";
  
  try {
    const response = await fetch(`${API}/wallet/cashout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: userId,
        amount: amount,
        bank_id: bankDetails.id
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      alert(`‚úÖ Cashout Successful!\n\nAmount: ‚Çπ${amount.toFixed(2)}\nTransaction ID: ${data.transaction_id}\n\nMoney will be transferred to your bank account.`);
      location.href = 'wallet.html';
    } else {
      alert("‚ùå " + data.detail);
      submitBtn.disabled = false;
      submitBtn.innerText = "Transfer Now";
    }
  } catch (error) {
    console.error('Error during cashout:', error);
    alert("‚ùå Failed to process cashout");
    submitBtn.disabled = false;
    submitBtn.innerText = "Transfer Now";
  }
}

// Validate on input
document.getElementById('amount-input')?.addEventListener('input', validateAmount);

// Initialize
loadBalance();
loadBankDetails();
</script>

</body>
</html>