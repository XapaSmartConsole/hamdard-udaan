<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Greaves Cotton | Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .resend-otp-container {
      text-align: center;
      margin-top: 15px;
      display: none;
    }

    .resend-otp-text {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .btn-resend {
      background: transparent;
      color: #0066B2;
      border: 1.5px solid #0066B2;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-resend:hover {
      background: #0066B2;
      color: #fff;
    }

    .btn-resend:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #ccc;
      color: #ccc;
    }

    .btn-resend:disabled:hover {
      background: transparent;
      color: #ccc;
    }

    .error-message {
      color: #dc3545;
      font-size: 13px;
      margin-top: 10px;
      text-align: center;
      display: none;
    }

    .success-message {
      color: #28a745;
      font-size: 13px;
      margin-top: 10px;
      text-align: center;
      display: none;
    }

    /* üî• DEMO OTP DISPLAY BOX */
    .demo-otp-box {
      background: #e8f4fd;
      border: 2px solid #0066B2;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
      display: none;
    }

    .demo-otp-label {
      font-size: 12px;
      color: #004D8C;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .demo-otp-code {
      font-size: 24px;
      font-weight: 700;
      color: #0066B2;
      letter-spacing: 4px;
      font-family: monospace;
    }
  </style>
</head>

<body class="auth-page">

  <!-- üîµ GREAVES COTTON HEADER WITH LOGO -->
  <div class="auth-header">
    <img src="assests/images/xapa logo.png" 
         alt="Greaves Cotton" 
         class="auth-brand-logo" 
         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
    <div class="auth-brand-text" style="display: none;">Greaves Cotton</div>
  </div>

  <!-- WHITE CARD -->
  <div class="auth-container">

    <h2 class="auth-title">Sign In</h2>
    <p class="auth-subtitle">
      Enter your registered mobile number
    </p>

    <!-- LOGIN FORM -->
    <form id="login-form">

      <!-- MOBILE -->
      <input
        type="tel"
        id="phone"
        placeholder="Mobile Number"
        maxlength="10"
        required
      >

      <!-- SEND OTP -->
      <button class="btn-primary" type="button" id="send-otp-btn">
        Send OTP
      </button>

      <!-- üî• DEMO OTP DISPLAY BOX -->
      <div class="demo-otp-box" id="demo-otp-box">
        <div class="demo-otp-label">üîê Demo OTP (For Testing)</div>
        <div class="demo-otp-code" id="demo-otp-display">------</div>
      </div>

      <!-- OTP INPUT (HIDDEN INITIALLY) -->
      <input
        type="text"
        id="otp"
        placeholder="Enter OTP"
        maxlength="6"
        style="display:none"
      >

      <!-- VERIFY OTP -->
      <button
        class="btn-primary"
        type="button"
        id="verify-otp-btn"
        style="display:none"
      >
        Continue
      </button>

      <!-- ERROR MESSAGE -->
      <div class="error-message" id="error-message"></div>

      <!-- SUCCESS MESSAGE -->
      <div class="success-message" id="success-message"></div>

      <!-- RESEND OTP CONTAINER -->
      <div class="resend-otp-container" id="resend-container">
        <p class="resend-otp-text">Didn't receive OTP?</p>
        <button class="btn-resend" type="button" id="resend-otp-btn">
          Resend OTP <span id="resend-timer"></span>
        </button>
      </div>

    </form>

    <p class="switch-text">
      Don't have an account?
      <a href="signup.html">Register Now</a>
    </p>

  </div>

  <script>
    const API_BASE = window.location.hostname === 'localhost' 
      ? "http://127.0.0.1:8001/api" 
      : "https://hamdard-udaan-1.onrender.com/api";

    let resendTimer;
    let resendCountdown = 30;

    // ========== SEND OTP ==========
    document.getElementById("send-otp-btn").addEventListener("click", function() {
      const phone = document.getElementById("phone").value;

      if (phone.length !== 10) {
        showError("Please enter a valid 10-digit mobile number");
        return;
      }

      sendOTP(phone);
    });

    function sendOTP(phone) {
      const btn = document.getElementById("send-otp-btn");
      btn.disabled = true;
      btn.innerText = "Sending...";

      // ‚úÖ FIXED: Send as query parameter
      fetch(`${API_BASE}/send-otp?phone=${phone}`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json"
        }
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        if (data.error) {
          showError(data.error);
          btn.disabled = false;
          btn.innerText = "Send OTP";
          return;
        }

        // Show success message
        showSuccess("OTP sent successfully!");

        // üî• DISPLAY OTP ON FRONTEND (DEMO MODE)
        if (data.demo_otp) {
          document.getElementById("demo-otp-display").innerText = data.demo_otp;
          document.getElementById("demo-otp-box").style.display = "block";
          console.log("üîê DEMO OTP:", data.demo_otp);
        }

        // Show OTP field and verify button
        document.getElementById("otp").style.display = "block";
        document.getElementById("verify-otp-btn").style.display = "block";
        document.getElementById("resend-container").style.display = "block";

        // Disable phone input
        document.getElementById("phone").disabled = true;

        // Hide send OTP button
        btn.style.display = "none";

        // Start resend timer
        startResendTimer();

        // Focus on OTP input
        document.getElementById("otp").focus();
      })
      .catch(err => {
        console.error("Send OTP Error:", err);
        showError("Failed to send OTP. Please try again.");
        btn.disabled = false;
        btn.innerText = "Send OTP";
      });
    }

    // ========== VERIFY OTP ==========
    document.getElementById("verify-otp-btn").addEventListener("click", function() {
      const phone = document.getElementById("phone").value;
      const otp = document.getElementById("otp").value;

      if (otp.length !== 6) {
        showError("Please enter a valid 6-digit OTP");
        return;
      }

      const btn = this;
      btn.disabled = true;
      btn.innerText = "Verifying...";

      // ‚úÖ FIXED: Send as query parameters
      fetch(`${API_BASE}/verify-otp?phone=${phone}&otp=${otp}`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json"
        }
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        if (data.success) {
          localStorage.setItem("user_id", data.user_id);
          localStorage.setItem("ham_code", data.ham_code);
          showSuccess("Login successful! Redirecting...");
          
          setTimeout(() => {
            window.location.href = "home.html";
          }, 1000);
        } else {
          showError("Invalid OTP. Please try again or resend OTP.");
          btn.disabled = false;
          btn.innerText = "Continue";
          
          // Clear OTP input
          document.getElementById("otp").value = "";
          document.getElementById("otp").focus();
        }
      })
      .catch(err => {
        console.error("Verify OTP Error:", err);
        showError("Verification failed. Please try again.");
        btn.disabled = false;
        btn.innerText = "Continue";
      });
    });

    // ========== RESEND OTP ==========
    document.getElementById("resend-otp-btn").addEventListener("click", function() {
      const phone = document.getElementById("phone").value;
      
      if (this.disabled) return;

      this.disabled = true;
      this.innerText = "Sending...";

      // ‚úÖ FIXED: Send as query parameter
      fetch(`${API_BASE}/send-otp?phone=${phone}`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json"
        }
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        if (data.error) {
          showError(data.error);
          this.disabled = false;
          this.innerText = "Resend OTP";
          return;
        }

        showSuccess("OTP resent successfully!");

        // üî• UPDATE OTP DISPLAY ON FRONTEND
        if (data.demo_otp) {
          document.getElementById("demo-otp-display").innerText = data.demo_otp;
          document.getElementById("demo-otp-box").style.display = "block";
          console.log("üîê DEMO OTP:", data.demo_otp);
        }
        
        // Clear OTP input
        document.getElementById("otp").value = "";
        document.getElementById("otp").focus();

        // Start timer again
        startResendTimer();
      })
      .catch(err => {
        console.error("Resend OTP Error:", err);
        showError("Failed to resend OTP. Please try again.");
        this.disabled = false;
        this.innerText = "Resend OTP";
      });
    });

    // ========== RESEND TIMER (COMPLETE) ==========
    function startResendTimer() {
      resendCountdown = 30;
      const resendBtn = document.getElementById("resend-otp-btn");
      const timerSpan = document.getElementById("resend-timer");

      if (!resendBtn || !timerSpan) return; // Safety check

      resendBtn.disabled = true;
      
      clearInterval(resendTimer);
      resendTimer = setInterval(() => {
        resendCountdown--;
        timerSpan.innerText = `(${resendCountdown}s)`;

        if (resendCountdown <= 0) {
          clearInterval(resendTimer);
          resendBtn.disabled = false;
          timerSpan.innerText = "";
          resendBtn.innerText = "Resend OTP";
        }
      }, 1000);
    }

    // ========== HELPER FUNCTIONS ==========
    function showError(message) {
      const errorDiv = document.getElementById("error-message");
      const successDiv = document.getElementById("success-message");
      
      if (successDiv) successDiv.style.display = "none";
      if (errorDiv) {
        errorDiv.innerText = message;
        errorDiv.style.display = "block";

        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 5000);
      }
    }

    function showSuccess(message) {
      const errorDiv = document.getElementById("error-message");
      const successDiv = document.getElementById("success-message");
      
      if (errorDiv) errorDiv.style.display = "none";
      if (successDiv) {
        successDiv.innerText = message;
        successDiv.style.display = "block";

        setTimeout(() => {
          successDiv.style.display = "none";
        }, 3000);
      }
    }

    // ========== ENTER KEY SUPPORT ==========
    document.getElementById("phone").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("send-otp-btn").click();
      }
    });

    document.getElementById("otp").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("verify-otp-btn").click();
      }
    });
  </script>

</body>
</html>